<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Artigiano V24</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#C0392B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css?v=24"> 

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>

<div id="app" :data-theme="temaEscuro ? 'dark' : 'light'" v-cloak>

    <div v-if="false" style="padding:20px; text-align:center; color:red;">
        <h1>Erro de Carregamento</h1>
        <p>Se voc√™ est√° vendo isso, atualize a p√°gina.</p>
    </div>

    <div class="login-overlay" v-if="!usuarioLogado">
        <div class="login-box">
            <i class="fas fa-user-lock fa-3x" style="color:var(--primary); margin-bottom:15px;"></i>
            <h2>Identifique-se</h2>
            <p style="color:var(--text-sec); font-size:0.9rem;">Digite seu PIN de acesso</p>
            
            <div class="pin-display">
                <span v-for="n in pinDigitado.length" :key="n">‚óè</span>
            </div>

            <div class="numpad">
                <button v-for="n in 9" :key="n" @click="addPin(n)">{{ n }}</button>
                <button @click="limparPin" style="background:#e74c3c; color:white;"><i class="fas fa-times"></i></button>
                <button @click="addPin(0)">0</button>
                <button @click="tentarLogin" style="background:#27ae60; color:white;"><i class="fas fa-arrow-right"></i></button>
            </div>
            
            <p v-if="erroLogin" style="color:red; margin-top:10px; font-size:0.8rem;">{{ erroLogin }}</p>
            
            <div v-if="usuarios.length === 0" style="margin-top:20px; border-top:1px solid #ddd; padding-top:10px;">
                <p style="font-size:0.8rem;">Primeiro acesso? Crie o Admin:</p>
                <input v-model="novoUsuarioNome" placeholder="Seu Nome" class="form-input" style="text-align:center;">
                <input v-model="novoUsuarioPin" placeholder="Crie um PIN (Ex: 1234)" type="number" class="form-input" style="text-align:center; margin-top:5px;">
                <button class="btn-full" @click="criarPrimeiroAdmin" style="margin-top:5px;">Criar Admin</button>
            </div>
        </div>
    </div>

    <div v-if="usuarioLogado">
        <div class="start-screen" v-if="!modoSelecionado">
            <div class="header-actions" style="position:absolute; top:20px; right:20px;">
                <button class="header-btn" @click="abrirAjuda('inicio')"><i class="fas fa-question-circle"></i></button>
                <button class="header-btn" @click="logout"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            <div class="start-content">
                <div style="margin-bottom:30px;">
                    <h1>Ol√°, {{ usuarioLogado.nome }}!</h1>
                    <p>O que vamos contar hoje?</p>
                </div>
                <button class="mode-btn btn-sacolao" @click="selecionarModo('sacolao')"><i class="fas fa-carrot fa-2x"></i><br>SACOL√ÉO</button>
                <button class="mode-btn btn-geral" @click="selecionarModo('geral')"><i class="fas fa-boxes fa-2x"></i><br>GERAL</button>
                <button class="btn-outline" @click="selecionarModo('todos')" style="margin-top:20px; width:100%;">Ver Tudo</button>
            </div>
        </div>

        <div class="header" v-if="modoSelecionado && !mostrandoPreview">
            <div>
                <div @click="modoSelecionado = null" style="font-size:0.7rem; color:var(--text-sec); cursor:pointer;"><i class="fas fa-arrow-left"></i> Voltar</div>
                <h1>{{ modoSelecionado === 'sacolao' ? 'ü•¨ Sacol√£o' : (modoSelecionado === 'geral' ? 'üì¶ Geral' : 'üçï Tudo') }}</h1>
            </div>
            <div class="header-actions">
                <button class="header-btn" @click="abrirAjuda('lista')"><i class="fas fa-question-circle"></i></button>
                <button class="header-btn" @click="toggleHistorico"><i class="fas fa-history"></i></button>
                <button class="header-btn" @click="toggleConfig"><i class="fas fa-cog"></i></button>
            </div>
        </div>

        <div class="progress-container" v-if="modoSelecionado && !mostrandoPreview && !mostrandoConfig && !mostrandoHistorico && produtosFiltrados.length > 0">
            <div class="progress-bar-bg"><div class="progress-fill" :style="{width: percentualConcluido + '%'}"></div></div>
            <div class="progress-text">{{ itensContados }} de {{ produtosFiltrados.length }}</div>
        </div>

        <div class="feriado-alert" v-if="modoSelecionado && !mostrandoPreview && !mostrandoConfig">
            <div v-if="lembreteDoDia" style="background:#e67e22; color:white; padding:5px; border-radius:5px; margin-bottom:5px;">üîî Lembrete: {{ lembreteDoDia.texto }}</div>
            <div v-if="feriadoAtivo">üéâ Feriado: {{ feriadoAtivo.nome }} (+50%)</div>
            <div v-else-if="diaDaSemana === 5 && modoSelecionado !== 'geral'">üìÖ Hoje √© Sexta! Sacol√£o x3.</div>
        </div>

        <div class="search-bar" v-if="modoSelecionado && !mostrandoPreview && !mostrandoConfig && !mostrandoHistorico">
            <input type="text" class="search-input" v-model="termoBusca" placeholder="üîç Buscar...">
        </div>

        <div v-if="modoSelecionado && !mostrandoConfig && !mostrandoPreview && !mostrandoHistorico" class="cards-container">
            <div v-if="produtosFiltrados.length === 0" style="text-align:center; padding:50px; color:var(--text-sec);">
                <i class="fas fa-check-circle fa-3x"></i><br>Nenhum produto.
            </div>

            <div v-for="local in rotaExibicao" :key="local">
                <div v-if="produtosDoLocal(local).length > 0" class="local-header"><i class="fas fa-map-marker-alt"></i> {{ local }}</div>
                <div v-for="p in produtosDoLocal(local)" :key="p.id" class="prod-card" :class="{ ignorado: p.ignorar, pedir: calculaFalta(p).qtd > 0 && !p.ignorar, ok: calculaFalta(p).qtd <= 0 && !p.ignorar }">
                    <div class="card-top">
                        <div><div class="prod-name">{{ p.nome }} <i class="fas fa-pen" @click="editarProduto(p)" style="font-size:0.7rem; color:var(--text-sec);"></i></div><div class="prod-meta">Meta: {{ p.meta }} {{ p.unC }}</div></div>
                        <div v-if="p.destinoId" class="badge-fornecedor">{{ getNomeDestino(p.destinoId) }}</div>
                    </div>
                    <div class="action-area">
                        <button class="ignore-btn" :class="{active: p.ignorar}" @click="toggleIgnorar(p)"><i class="fas fa-ban" v-if="p.ignorar"></i><i class="far fa-thumbs-up" v-else></i></button>
                        <div class="qty-box" :class="{focused: p.focado}" @click="focarInput(p.id)">
                            <label>Contar ({{ p.unQ }})</label>
                            <input :id="'input-'+p.id" type="number" v-model.number="p.contagem" @input="sincronizarAlteracao" placeholder="-" :disabled="p.ignorar" @focus="p.focado=true" @blur="p.focado=false" inputmode="decimal">
                        </div>
                    </div>
                    <div class="item-obs"><i class="fas fa-pen"></i><input type="text" v-model="p.obs" @change="sincronizarAlteracao" placeholder="Obs..."></div>
                    <div class="feedback-bar" v-if="!p.ignorar && p.contagem !== ''">
                        <span v-if="calculaFalta(p).qtd > 0" style="color:var(--danger);">PEDIR: {{ calculaFalta(p).qtd }} {{ p.unC }}</span>
                        <span v-else style="color:var(--success);">OK</span>
                    </div>
                </div>
            </div>
            <div v-if="produtosFiltrados.length > 0" class="finalizar-card" @click="abrirPreview"><h2>FINALIZAR</h2></div>
        </div>

        <div class="modal-overlay" :class="{open: mostrandoPreview}"><div class="modal-header"><h2>Enviar</h2><button class="close-btn" @click="mostrandoPreview = false">X</button></div><button class="header-btn" @click="abrirAjuda('envio')" style="position: absolute; top:20px; right:60px;"><i class="fas fa-question-circle"></i></button><div v-for="(itens, destinoId) in pedidosPorDestino" :key="destinoId" class="supplier-card"><div class="supplier-header"><span>{{ getNomeDestino(destinoId) }}</span><span>{{ itens.length }} itens</span></div><div class="supplier-items"><div v-for="item in itens" style="border-bottom:1px solid #eee;">{{ item.texto }}</div></div><button class="btn-whatsapp" @click="enviarWhatsApp(destinoId, itens)">Enviar WhatsApp</button></div></div>

        <div class="modal-overlay" :class="{open: mostrandoHistorico}"><div class="modal-header"><h2>Hist√≥rico</h2><button class="close-btn" @click="mostrandoHistorico = false">X</button></div><div v-for="(h, index) in historico" :key="index" style="background:var(--card); padding:15px; margin-bottom:10px; border:1px solid var(--border); border-radius:10px;"><div style="font-weight:bold; font-size:0.8rem; border-bottom:1px solid #eee; padding-bottom:5px;">{{ h.data }} - <span style="color:var(--primary);">{{ h.usuario }}</span><i class="fas fa-trash" @click="apagarHistorico(index)" style="float:right; color:#999;"></i></div><div style="font-size:0.9rem; font-weight:800; margin-top:5px;">{{ h.destino }}</div><div style="font-size:0.85rem; margin-top:5px; white-space: pre-wrap; background:var(--input-bg); padding:5px;">{{ h.detalhes }}</div></div></div>

        <div class="modal-overlay" :class="{open: mostrandoConfig}"><div class="modal-header"><h2>Configura√ß√µes</h2><button class="close-btn" @click="mostrandoConfig = false">X</button></div><button class="header-btn" @click="abrirAjuda('config')" style="position: absolute; top:20px; right:60px;"><i class="fas fa-question-circle"></i></button>
            <div class="config-group"><div class="group-title"><i class="fas fa-users"></i> Equipe (Login)</div><div style="padding:10px;"><div v-for="(u, idx) in usuarios" :key="idx" style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:8px;"><span>{{ u.nome }} (PIN: ****)</span><i class="fas fa-trash" @click="removerUsuario(idx)" style="color:red;"></i></div><div style="display:flex; gap:5px; margin-top:10px;"><input class="form-input" v-model="novoUsuarioNome" placeholder="Nome"><input class="form-input" type="number" v-model="novoUsuarioPin" placeholder="PIN (4 n√∫m)"></div><button class="btn-full" @click="adicionarUsuario" style="margin-top:5px; padding:8px;">Adicionar Usu√°rio</button></div></div>
            <div class="config-group"><div class="group-title"><i class="fas fa-bell"></i> Lembretes</div><div style="padding:10px;"><div v-for="(l, idx) in config.lembretes" :key="idx" style="border-bottom:1px solid #eee; padding:5px;"><span style="font-weight:bold;">{{ nomeDia(l.dia) }}:</span> {{ l.texto }}<i class="fas fa-trash" @click="removerLembrete(idx)" style="float:right; color:red;"></i></div><div style="display:flex; gap:5px; margin-top:10px;"><select class="form-input" v-model="novoLembrete.dia"><option value="1">Seg</option><option value="2">Ter</option><option value="3">Qua</option><option value="4">Qui</option><option value="5">Sex</option><option value="6">S√°b</option><option value="0">Dom</option></select><input class="form-input" v-model="novoLembrete.texto" placeholder="Ex: Pedir G√°s"></div><button class="btn-full" @click="adicionarLembrete" style="margin-top:5px; padding:8px;">Salvar Lembrete</button></div></div>
            <div class="config-group"><div class="group-title">Novo Produto</div><div style="padding:15px;"><input class="form-input" v-model="novoProd.nome" placeholder="Nome"><div style="display:flex; gap:5px;"><select class="form-input" v-model="novoProd.setor"><option value="" disabled>Local</option><option v-for="l in config.rota" :value="l">{{ l }}</option></select><select class="form-input" v-model="novoProd.destinoId"><option value="" disabled>Destino</option><option v-for="d in config.destinos" :value="d.id">{{ d.nome }}</option></select></div><div style="display:flex; gap:5px;"><input class="form-input" v-model="novoProd.unQ" placeholder="Conta Un"><input class="form-input" v-model="novoProd.unC" placeholder="Pede Cx"></div><input type="number" class="form-input" v-model.number="novoProd.fator" placeholder="Qtd na Cx"><input type="number" class="form-input" v-model.number="novoProd.meta" placeholder="Meta"><button class="btn-full" @click="salvarEdicao" v-if="editandoId">Salvar</button><button class="btn-full" @click="adicionarProduto" v-else>Cadastrar</button></div></div>
            <div class="config-group"><div class="group-title">Destinos</div><div style="padding:10px;"><div v-for="(d, idx) in config.destinos" :key="d.id">{{ d.nome }} <i class="fas fa-trash" @click="removerDestino(idx)"></i></div><div style="margin-top:5px; display:flex; gap:5px;"><input class="form-input" v-model="novoDestino.nome" placeholder="Nome"><input class="form-input" v-model="novoDestino.telefone" placeholder="Zap"></div><button class="btn-full" @click="adicionarDestino" style="margin-top:5px;">Add</button></div></div>
            <div class="config-section"><button class="btn-outline" @click="resetarTudo" style="color:red; border-color:red;">Resetar Tudo</button></div>
        </div>

        <div class="modal-overlay" :class="{open: modalAjudaAberta}"><div class="modal-header"><h2>Ajuda</h2><button class="close-btn" @click="modalAjudaAberta = false">X</button></div><div class="modal-content" style="background:var(--bg); padding:20px;"><div v-html="textoAjuda"></div><button class="btn-full" @click="modalAjudaAberta = false" style="margin-top:20px;">Entendi</button></div></div>
    </div>

</div>

<script src="script.js?v=24" defer></script>

</body>
</html>
