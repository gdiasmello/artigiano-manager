<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Artigiano iOS</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F2F2F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css?v=25">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>

<div id="app" v-cloak>

    <div class="ios-login" v-if="!usuarioLogado">
        <div class="ios-login-content">
            <div style="margin-bottom: 30px;">
                <i class="fas fa-pizza-slice fa-3x" style="color:#FF3B30;"></i>
                <h2 style="margin-top:10px;">Artigiano</h2>
                <p style="color:#8E8E93;">Digite o PIN</p>
            </div>

            <div class="pin-dots">
                <div class="dot" :class="{active: pinDigitado.length >= 1}"></div>
                <div class="dot" :class="{active: pinDigitado.length >= 2}"></div>
                <div class="dot" :class="{active: pinDigitado.length >= 3}"></div>
                <div class="dot" :class="{active: pinDigitado.length >= 4}"></div>
            </div>

            <p v-if="erroLogin" style="color:#FF3B30; font-weight:600; min-height:20px;">{{ erroLogin }}</p>
            <p v-else style="min-height:20px;"></p>

            <div class="ios-numpad">
                <button v-for="n in 9" :key="n" @click="addPin(n)">{{ n }}</button>
                <div style="opacity:0"></div> <button @click="addPin(0)">0</button>
                <button @click="limparPin" style="background:none; box-shadow:none; color:#333;"><i class="fas fa-backspace"></i></button>
            </div>

            <div v-if="usuarios.length === 0" class="admin-setup">
                <h3>Bem-vindo, Chefe!</h3>
                <p>Crie o acesso Admin:</p>
                <input v-model="novoUsuarioNome" placeholder="Seu Nome" class="ios-input">
                <input v-model="novoUsuarioPin" type="tel" placeholder="Crie um PIN (4 dÃ­gitos)" class="ios-input" maxlength="4">
                <button class="ios-btn-primary" @click="criarPrimeiroAdmin">Criar Sistema</button>
            </div>
        </div>
    </div>

    <div v-else class="app-layout">
        
        <div class="status-bar" :class="{offline: !conectado}">
            {{ conectado ? 'Sincronizado' : 'Offline' }}
        </div>

        <div class="ios-header">
            <div class="left">
                <button v-if="modoSelecionado" @click="modoSelecionado = null" class="btn-text">
                    <i class="fas fa-chevron-left"></i> Voltar
                </button>
            </div>
            <div class="center">
                <span v-if="!modoSelecionado">InÃ­cio</span>
                <span v-else>{{ modoSelecionado === 'sacolao' ? 'SacolÃ£o' : 'Geral' }}</span>
            </div>
            <div class="right">
                <button @click="logout" class="btn-icon"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="ios-content">
            
            <div v-if="!modoSelecionado" class="menu-grid">
                <div class="welcome-card">
                    <h1>OlÃ¡, {{ usuarioLogado.nome }}!</h1>
                    <p>{{ dataHoje }}</p>
                </div>

                <button class="menu-card green" @click="selecionarModo('sacolao')">
                    <i class="fas fa-carrot"></i>
                    <span>SacolÃ£o</span>
                </button>
                <button class="menu-card orange" @click="selecionarModo('geral')">
                    <i class="fas fa-box-open"></i>
                    <span>Geral</span>
                </button>
                <button class="menu-card blue" @click="selecionarModo('todos')">
                    <i class="fas fa-list"></i>
                    <span>Ver Tudo</span>
                </button>

                <div class="quick-actions">
                    <button @click="toggleHistorico"><i class="fas fa-history"></i> HistÃ³rico</button>
                    <button @click="toggleConfig"><i class="fas fa-cog"></i> Ajustes</button>
                </div>
            </div>

            <div v-else>
                <div v-if="lembreteDoDia" class="ios-alert orange">ðŸ”” {{ lembreteDoDia.texto }}</div>
                <div v-if="feriadoAtivo" class="ios-alert purple">ðŸŽ‰ Feriado: {{ feriadoAtivo.nome }} (+50%)</div>
                <div v-if="diaDaSemana === 5 && modoSelecionado === 'sacolao'" class="ios-alert green">ðŸ“… Sexta-feira: Meta x3</div>

                <div class="ios-search">
                    <i class="fas fa-search"></i>
                    <input v-model="termoBusca" placeholder="Buscar produto...">
                </div>

                <div v-if="produtosFiltrados.length === 0" class="empty-state">
                    <p>Nenhum item encontrado.</p>
                </div>

                <div v-for="local in rotaExibicao" :key="local" class="section-group">
                    <div v-if="produtosDoLocal(local).length > 0" class="section-title">{{ local }}</div>
                    
                    <div v-for="p in produtosDoLocal(local)" :key="p.id" class="ios-list-item" :class="{checked: calculaFalta(p).qtd <= 0 && !p.ignorar}">
                        <div class="item-info">
                            <div class="item-name">{{ p.nome }}</div>
                            <div class="item-meta">Meta: {{ p.meta }} {{ p.unC }}</div>
                        </div>
                        <div class="item-actions">
                            <input 
                                type="tel" 
                                v-model.number="p.contagem" 
                                :placeholder="p.unQ" 
                                class="qty-input"
                                :disabled="p.ignorar"
                                @input="sincronizarAlteracao"
                            >
                            <button class="action-btn" @click="toggleIgnorar(p)" :class="{ignored: p.ignorar}">
                                <i class="fas fa-ban" v-if="p.ignorar"></i>
                                <i class="fas fa-check" v-else></i>
                            </button>
                        </div>
                        <div class="item-status" v-if="!p.ignorar && p.contagem !== ''">
                            <span v-if="calculaFalta(p).qtd > 0" style="color:#FF3B30;">PEDIR {{ calculaFalta(p).qtd }} {{ p.unC }}</span>
                            <span v-else style="color:#34C759;">OK</span>
                        </div>
                    </div>
                </div>

                <div class="floating-fab" @click="abrirPreview" v-if="produtosFiltrados.length > 0">
                    <i class="fas fa-paper-plane"></i> Finalizar
                </div>
            </div>
        </div>
    </div>

    <div class="ios-modal-overlay" v-if="mostrandoConfig">
        <div class="ios-modal">
            <div class="modal-header">
                <h3>ConfiguraÃ§Ãµes</h3>
                <button @click="mostrandoConfig = false">Fechar</button>
            </div>
            <div class="modal-body">
                
                <div v-if="usuarioLogado.admin" class="config-section">
                    <h4>ðŸ‘¥ Equipe (Apenas Admin)</h4>
                    <div v-for="(u, idx) in usuarios" :key="idx" class="list-row">
                        <span>{{ u.nome }} <small v-if="u.admin">(Admin)</small></span>
                        <i class="fas fa-trash text-red" @click="removerUsuario(idx)" v-if="!u.admin"></i>
                    </div>
                    <div class="add-row">
                        <input v-model="novoUsuarioNome" placeholder="Nome">
                        <input v-model="novoUsuarioPin" placeholder="PIN" type="tel" style="width:60px">
                        <button @click="adicionarUsuario">Add</button>
                    </div>
                </div>
                <div v-else class="config-section">
                    <p style="text-align:center; color:#8E8E93;">SÃ³ o Gabriel (Admin) pode gerenciar usuÃ¡rios.</p>
                </div>

                <div class="config-section">
                    <h4>ðŸ”” Lembretes</h4>
                    <div v-for="(l, idx) in config.lembretes" :key="idx" class="list-row">
                        <span><b>{{ nomeDia(l.dia) }}</b>: {{ l.texto }}</span>
                        <i class="fas fa-trash text-red" @click="removerLembrete(idx)"></i>
                    </div>
                    <div class="add-row">
                        <select v-model="novoLembrete.dia"><option value="1">Seg</option><option value="5">Sex</option></select>
                        <input v-model="novoLembrete.texto" placeholder="Ex: GÃ¡s">
                        <button @click="adicionarLembrete">Add</button>
                    </div>
                </div>

                <div class="config-section">
                    <h4>ðŸ“¦ Produtos</h4>
                    <div class="add-column">
                        <input v-model="novoProd.nome" placeholder="Nome do Produto">
                        <div class="row">
                            <select v-model="novoProd.setor"><option value="" disabled>Local</option><option v-for="l in config.rota" :value="l">{{ l }}</option></select>
                            <select v-model="novoProd.destinoId"><option value="" disabled>Destino</option><option v-for="d in config.destinos" :value="d.id">{{ d.nome }}</option></select>
                        </div>
                        <div class="row">
                            <input v-model="novoProd.unQ" placeholder="Conta (Un)">
                            <input v-model="novoProd.unC" placeholder="Pede (Cx)">
                        </div>
                        <div class="row">
                            <input v-model.number="novoProd.fator" placeholder="Qtd na Cx" type="number">
                            <input v-model.number="novoProd.meta" placeholder="Meta MÃ­nima" type="number">
                        </div>
                        <button class="ios-btn-primary" @click="adicionarProduto">Cadastrar Produto</button>
                    </div>
                </div>

                <div class="config-section">
                    <button class="ios-btn-danger" @click="resetarTudo">Resetar App</button>
                </div>
            </div>
        </div>
    </div>

    <div class="ios-modal-overlay" v-if="mostrandoPreview">
        <div class="ios-modal">
            <div class="modal-header"><h3>Enviar Pedido</h3><button @click="mostrandoPreview = false">Fechar</button></div>
            <div class="modal-body">
                <div v-for="(itens, destinoId) in pedidosPorDestino" :key="destinoId" class="preview-card">
                    <h4>{{ getNomeDestino(destinoId) }} <span class="badge">{{ itens.length }}</span></h4>
                    <ul><li v-for="item in itens">{{ item.texto }}</li></ul>
                    <button class="ios-btn-success" @click="enviarWhatsApp(destinoId, itens)"><i class="fab fa-whatsapp"></i> Enviar</button>
                </div>
                <div style="margin-top:20px;">
                    <label>ObservaÃ§Ã£o Geral</label>
                    <textarea v-model="observacaoExtra" class="ios-textarea" placeholder="Ex: Entregar na lateral..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="ios-modal-overlay" v-if="mostrandoHistorico">
        <div class="ios-modal">
            <div class="modal-header"><h3>HistÃ³rico</h3><button @click="mostrandoHistorico = false">Fechar</button></div>
            <div class="modal-body">
                <div v-for="(h, index) in historico" :key="index" class="history-card">
                    <div class="hist-header">
                        <span class="hist-date">{{ h.data }}</span>
                        <span class="hist-user">{{ h.usuario }}</span>
                    </div>
                    <div class="hist-dest">{{ h.destino }}</div>
                    <div class="hist-body">{{ h.detalhes }}</div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="script.js?v=25"></script>
</body>
</html>
