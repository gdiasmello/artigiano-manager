const firebaseConfig = { 
    apiKey: "AIzaSyBL70gtkhjBvC9BiKvz5HBivH07JfRKuo4", 
    authDomain: "artigiano-app.firebaseapp.com", 
    databaseURL: "https://artigiano-app-default-rtdb.firebaseio.com", 
    projectId: "artigiano-app", 
    storageBucket: "artigiano-app.firebasestorage.app", 
    messagingSenderId: "212218495726", 
    appId: "1:212218495726:web:dd6fec7a4a8c7ad572a9ff" 
};

let db; 
try { 
    firebase.initializeApp(firebaseConfig); 
    db = firebase.database(); 
    db.ref().keepSynced(true); // OFFLINE PERSISTENCE
} catch (e) { console.error(e); }

const { createApp } = Vue

createApp({
    data() {
        return {
            loadingInicial: true, temaEscuro: false, sessaoAtiva: false, usuarioLogado: null,
            abaAtual: 'estoque', sobraMassa: 0, fichaTecnica: null,
            offline: !navigator.onLine, historicoAuditoria: [],
            // MANTIDO: Suas listas de itens, destinos e configs originais
            itens: [], categorias: ['Hortifruti', 'Geral', 'Bebidas', 'Limpeza'],
            config: { destinos: [], metas: { semana: 40, fds: 60 } },
            usuarios: [], msgAuth: '', isError: false, loadingAuth: false,
            loginUser: '', loginPass: ''
        }
    },
    methods: {
        // --- NOVAS FUNÇÕES ---
        registrarAuditoria(acao, detalhe) {
            if (!this.usuarioLogado) return;
            const log = {
                data: new Date().toLocaleString('pt-BR'),
                usuario: this.usuarioLogado.nome,
                acao: acao,
                detalhe: detalhe,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            db.ref('auditoria').push(log);
        },

        gerarPDFProducao() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFillColor(196, 30, 58);
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text("ARTIGIANO - PRODUÇÃO", 14, 20);
            doc.setTextColor(0, 0, 0);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 40);
            
            const rows = [
                ["Farinha", this.fichaTecnica.farinha + "g"],
                ["Água", this.fichaTecnica.agua + "ml"],
                ["Gelo", this.fichaTecnica.gelo + "g"],
                ["Levain", this.fichaTecnica.levain + "g"],
                ["Sal", this.fichaTecnica.sal + "g"]
            ];

            doc.autoTable({
                startY: 45,
                head: [['Ingrediente', 'Qtd']],
                body: rows,
                headStyles: { fillColor: [196, 30, 58] }
            });

            doc.save("Producao_Artigiano.pdf");
            this.registrarAuditoria("PDF", "Gerou ficha de produção");
        },

        // --- MANTIDO E MELHORADO: Login e Funções de Sistema ---
        fazerLogin() {
            this.loadingAuth = true;
            db.ref('usuarios').once('value', s => {
                const us = s.val();
                const u = Object.values(us || {}).find(x => x.user === this.loginUser && x.pass === this.loginPass);
                if(u) {
                    this.usuarioLogado = u;
                    this.sessaoAtiva = true;
                    localStorage.setItem('artigiano_session', JSON.stringify(u));
                    this.registrarAuditoria("Login", "Entrou no sistema");
                } else {
                    this.msgAuth = "Usuário/Senha incorretos";
                    this.isError = true;
                }
                this.loadingAuth = false;
            });
        },

        logout() {
            this.registrarAuditoria("Logout", "Saiu do sistema");
            this.sessaoAtiva = false;
            this.usuarioLogado = null;
            localStorage.removeItem('artigiano_session');
        },

        enviarZap(destinoId, itens) {
            // Sua lógica de montar texto do WhatsApp...
            this.registrarAuditoria("WhatsApp", `Pedido enviado para ${destinoId}`);
            // window.open(url, '_blank');
        },

        carregarDados() {
            db.ref('auditoria').limitToLast(50).on('value', s => {
                this.historicoAuditoria = s.val() ? Object.values(s.val()).reverse() : [];
            });
            // Carregar itens, config e usuários (seus códigos originais)
            db.ref('itens').on('value', s => { this.itens = s.val() || []; });
            db.ref('config').on('value', s => { this.config = s.val() || this.config; });
            db.ref('usuarios').on('value', s => { this.usuarios = Object.values(s.val() || {}); });
            this.loadingInicial = false;
        },

        alternarTema() {
            this.temaEscuro = !this.temaEscuro;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('artigiano_theme', this.temaEscuro ? 'dark' : 'light');
        }
    },
    mounted() {
        this.carregarDados();
        const s = localStorage.getItem('artigiano_session');
        if(s) { this.usuarioLogado = JSON.parse(s); this.sessaoAtiva = true; }
        if(localStorage.getItem('artigiano_theme') === 'dark') this.alternarTema();

        window.addEventListener('online', () => this.offline = false);
        window.addEventListener('offline', () => this.offline = true);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    }
}).mount('#app')
